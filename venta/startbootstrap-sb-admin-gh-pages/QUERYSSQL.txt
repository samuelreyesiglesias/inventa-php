USE [ICGSAP_BD]
GO
/****** Object:  StoredProcedure [dbo].[ICGSAP_SP_ComprasMigrar]    Script Date: 8/8/2023 16:17:18 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

 --select * from ICGSAP_TB_ConfigSucursal
 
 --  [dbo].[ICGSAP_SP_ComprasMigrar] '20230701', '20230731',4,6,5,0
 --[dbo].[ICGSAP_SP_ComprasMigrar]   '2023-08-01', '2023-08-08',2,2,6,0
ALTER PROC [dbo].[ICGSAP_SP_ComprasMigrar]  
 @FECHAINICIAL DATE,
 @FECHAFINAL DATE,
 @IDEMPRESA INT = 0,
 @IDEMPRESAMARCA INT = 0,
 @FO INT = 0,
 @CODPROVEEDOR INT=0
AS
BEGIN 
	DECLARE @FECHA_RECORRRIDO AS DATE; 
	DECLARE @DAY AS INT = 0;
	DECLARE @DIF_RANGO INT;

	DECLARE @Compra As Table (
    IdCompraCab INT,
    DocNum VARCHAR(50),
    DocEntry INT,
    NUMSERIE VARCHAR(50),
    NumAlbaran INT,
    SuAlbaran VARCHAR(50),
    CodProveedor VARCHAR(50),
    CARDCODE VARCHAR(50),
    CARDNAME VARCHAR(255),
    WHSCODE VARCHAR(50),
    DocDate DATETIME,
    DocDueDate DATETIME,
    TaxDate DATETIME,
    CANTIDADITEMS INT,
    DESCRIPCION VARCHAR(255),
    DOCSTATUS INT,
    COMMENTS VARCHAR(255),
    PROCESADO INT,
    SerieAlbaran VARCHAR(50),
    NUMPEDIDO VARCHAR(50),
    SUCURSAL VARCHAR(50),
    EMPRESA VARCHAR(255),
    NombreCorto VARCHAR(255),
    Marca VARCHAR(255),
    U_TIPODOC VARCHAR(50)
);


	SET DATEFORMAT YMD;  
	BEGIN TRY   
	  --BEGIN TRAN;

			SET @FECHA_RECORRRIDO=''; 
			SET @DAY   = 0; 
			SET @DIF_RANGO = (SELECT DATEDIFF(DAY, @FECHAINICIAL, @FECHAFINAL) + 1); 
			WHILE(@DAY < @DIF_RANGO)
			BEGIN
				SET @FECHA_RECORRRIDO = (SELECT DATEADD(DD, @DAY, CAST(CAST(@FECHAINICIAL AS DATE) AS DATETIME)));
			 print @DAY
				INSERT INTO @Compra (IdCompraCab, DocNum, DocEntry, NUMSERIE, NumAlbaran, SuAlbaran, CodProveedor, CARDCODE, CARDNAME, WHSCODE, DocDate, DocDueDate, TaxDate, CANTIDADITEMS, DESCRIPCION, DOCSTATUS, COMMENTS, PROCESADO, SerieAlbaran, NUMPEDIDO, SUCURSAL, EMPRESA, NombreCorto, Marca, U_TIPODOC)
				EXEC ICGSAP_BD.[dbo].[SERV_SP_MigrarCompras] @FECHA_RECORRRIDO, @FO,@CODPROVEEDOR
				SET @DAY = @DAY + 1;
			END 
			 
			 SELECT * FROM @Compra

		--COMMIT TRAN;
	END TRY
	BEGIN CATCH
		--IF @@TRANCOUNT>0
		--BEGIN	
		--	ROLLBACK TRAN;
		--END
		DECLARE @MESSAGE VARCHAR(MAX) =   ERROR_MESSAGE()  ;
		RAISERROR(	@MESSAGE,16,217);
	END CATCH
  
END


